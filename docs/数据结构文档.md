# ZFX 支付中心系统 - 数据结构文档

## 1. 数据库设计概述

### 1.1 数据库信息
- **数据库类型**: MySQL 8.0+
- **字符集**: utf8mb4
- **排序规则**: utf8mb4_general_ci
- **数据库名**: smart_admin_v3

### 1.2 表结构设计原则
- 采用标准化的数据库设计
- 支持数据加密存储
- 完善的索引设计
- 审计日志记录
- 软删除机制

## 2. 核心业务表结构

### 2.1 支付订单信息表 (t_payment_order_info)

#### 表结构
| 字段名 | 数据类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|----------|------|----------|--------|------|
| id | bigint | - | NO | AUTO_INCREMENT | 主键ID |
| platform_id | bigint | - | YES | NULL | 商户ID |
| channel_id | bigint | - | YES | NULL | 渠道商户ID |
| business_id | bigint | - | YES | NULL | 业务范围ID |
| order_no | varchar | 100 | NO | - | 订单编号 |
| deposit_type | varchar | 50 | YES | NULL | 银行类型(bank/qrcode) |
| payment_channel | varchar | 50 | YES | NULL | 二维码渠道 |
| amount | decimal | 15,2 | NO | - | 存款金额 |
| account_name | varchar | 100 | YES | NULL | 银行账户(加密) |
| account_name_hash | varchar | 255 | YES | NULL | 账户名哈希 |
| bank_account | varchar | 50 | YES | NULL | 银行卡号码(加密) |
| bank_code | varchar | 20 | YES | NULL | 银行代码 |
| deposit_remark | varchar | 500 | YES | NULL | 存款备注 |
| user_id | bigint | - | YES | NULL | 用户ID |
| callback | varchar | 500 | YES | NULL | 订单确认通知回调地址 |
| landing_url | varchar | 500 | YES | NULL | 前端回调地址 |
| apply_time | bigint | - | YES | NULL | 申请时间 |
| expired_time | bigint | - | YES | NULL | 订单过期时间 |
| finished_time | bigint | - | YES | NULL | 订单完成时间 |
| name | varchar | 200 | YES | NULL | 商品名称 |
| client_ip | varchar | 50 | YES | NULL | 用户IP地址 |
| device | varchar | 100 | YES | NULL | 用户设备类型 |
| email | varchar | 100 | YES | NULL | 电子邮箱(加密) |
| currency | varchar | 10 | YES | NULL | 币种 |
| country | varchar | 50 | YES | NULL | 国家 |
| ext | text | - | YES | NULL | 额外参数 |
| qrcode_id | bigint | - | YES | NULL | 二维码文件ID |
| thirdparty_order_no | varchar | 100 | YES | NULL | 第三方订单编号 |
| sub_mer_name | varchar | 100 | YES | NULL | 子商户名称 |
| payment_status | int | - | YES | NULL | 支付状态(1待付款 2已付款 3已取消 4过期) |
| status | int | - | YES | NULL | 订单状态(1待确认 2已确认 3挂起) |
| bill_file_id | bigint | - | YES | NULL | 支付单据文件ID |
| retry | int | - | YES | NULL | 查询重试次数 |
| create_time | datetime | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

#### 索引设计
```sql
PRIMARY KEY (`id`),
INDEX `idx_order_no` (`order_no`),
INDEX `idx_platform_id` (`platform_id`),
INDEX `idx_payment_status` (`payment_status`),
INDEX `idx_status` (`status`),
INDEX `idx_create_time` (`create_time`),
INDEX `idx_account_name_hash` (`account_name_hash`)
```

### 2.2 现金订单信息表 (t_cash_order_info)

#### 表结构
| 字段名 | 数据类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|----------|------|----------|--------|------|
| id | bigint | - | NO | AUTO_INCREMENT | 主键ID |
| order_no | varchar | 100 | NO | - | 订单编号 |
| merchant_id | bigint | - | YES | NULL | 商户ID |
| amount | decimal | 15,2 | NO | - | 充值金额 |
| currency | varchar | 10 | YES | NULL | 币种 |
| payment_method | varchar | 50 | YES | NULL | 支付方式 |
| account_name | varchar | 100 | YES | NULL | 付款人姓名 |
| bank_account | varchar | 50 | YES | NULL | 付款账号 |
| deposit_remark | varchar | 500 | YES | NULL | 存款备注 |
| receipt_file_id | bigint | - | YES | NULL | 回单文件ID |
| status | int | - | YES | NULL | 订单状态 |
| operator_id | bigint | - | YES | NULL | 操作员ID |
| remark | varchar | 500 | YES | NULL | 备注 |
| create_time | datetime | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

### 2.3 商户信息表 (t_merchant_info)

#### 表结构
| 字段名 | 数据类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|----------|------|----------|--------|------|
| id | bigint | - | NO | AUTO_INCREMENT | 主键ID |
| merchant_name | varchar | 100 | NO | - | 商户名称 |
| merchant_code | varchar | 50 | NO | - | 商户编码 |
| contact_name | varchar | 50 | YES | NULL | 联系人姓名 |
| contact_phone | varchar | 20 | YES | NULL | 联系电话 |
| contact_email | varchar | 100 | YES | NULL | 联系邮箱 |
| business_license | varchar | 100 | YES | NULL | 营业执照号 |
| status | int | - | NO | 1 | 商户状态(0禁用 1正常) |
| remark | varchar | 500 | YES | NULL | 备注 |
| create_time | datetime | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

### 2.4 支付渠道信息表 (t_payment_channel_info)

#### 表结构
| 字段名 | 数据类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|----------|------|----------|--------|------|
| id | bigint | - | NO | AUTO_INCREMENT | 主键ID |
| channel_name | varchar | 100 | NO | - | 渠道名称 |
| channel_code | varchar | 50 | NO | - | 渠道编码 |
| channel_type | varchar | 20 | NO | - | 渠道类型(bank/qrcode) |
| fee_rate | decimal | 5,4 | YES | NULL | 手续费率 |
| config_json | text | - | YES | NULL | 渠道配置JSON |
| status | int | - | NO | 1 | 渠道状态(0禁用 1启用) |
| remark | varchar | 500 | YES | NULL | 备注 |
| create_time | datetime | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

### 2.5 结算信息表 (t_settlement_info)

#### 表结构
| 字段名 | 数据类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|----------|------|----------|--------|------|
| id | bigint | - | NO | AUTO_INCREMENT | 主键ID |
| settlement_no | varchar | 100 | NO | - | 结算单号 |
| merchant_id | bigint | - | NO | - | 商户ID |
| settlement_amount | decimal | 15,2 | NO | - | 结算金额 |
| fee_amount | decimal | 15,2 | YES | NULL | 手续费金额 |
| actual_amount | decimal | 15,2 | NO | - | 实际结算金额 |
| settlement_status | int | - | NO | 1 | 结算状态(1待结算 2已结算 3结算失败) |
| settlement_time | datetime | - | YES | NULL | 结算时间 |
| operator_id | bigint | - | YES | NULL | 操作员ID |
| remark | varchar | 500 | YES | NULL | 备注 |
| create_time | datetime | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

## 3. 系统管理表结构

### 3.1 用户表 (t_employee)

#### 表结构
| 字段名 | 数据类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|----------|------|----------|--------|------|
| employee_id | bigint | - | NO | AUTO_INCREMENT | 员工ID |
| login_name | varchar | 30 | NO | - | 登录名 |
| actual_name | varchar | 50 | NO | - | 真实姓名 |
| id_card | varchar | 18 | YES | NULL | 身份证号(加密) |
| phone | varchar | 15 | YES | NULL | 手机号(加密) |
| department_id | bigint | - | YES | NULL | 部门ID |
| is_disabled | tinyint | - | NO | 0 | 是否禁用 |
| is_deleted | tinyint | - | NO | 0 | 是否删除 |
| create_time | datetime | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

### 3.2 角色表 (t_role)

#### 表结构
| 字段名 | 数据类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|----------|------|----------|--------|------|
| role_id | bigint | - | NO | AUTO_INCREMENT | 角色ID |
| role_name | varchar | 20 | NO | - | 角色名称 |
| remark | varchar | 255 | YES | NULL | 备注 |
| create_time | datetime | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

### 3.3 菜单表 (t_menu)

#### 表结构
| 字段名 | 数据类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|----------|------|----------|--------|------|
| menu_id | bigint | - | NO | AUTO_INCREMENT | 菜单ID |
| menu_name | varchar | 20 | NO | - | 菜单名称 |
| menu_type | tinyint | - | NO | - | 菜单类型(1目录 2菜单 3按钮) |
| parent_id | bigint | - | NO | - | 父级ID |
| sort | int | - | NO | 0 | 排序 |
| path | varchar | 200 | YES | NULL | 路由地址 |
| component | varchar | 200 | YES | NULL | 组件路径 |
| perms | varchar | 100 | YES | NULL | 权限标识 |
| icon | varchar | 100 | YES | NULL | 图标 |
| create_time | datetime | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

### 3.4 部门表 (t_department)

#### 表结构
| 字段名 | 数据类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|----------|------|----------|--------|------|
| department_id | bigint | - | NO | AUTO_INCREMENT | 部门ID |
| name | varchar | 50 | NO | - | 部门名称 |
| parent_id | bigint | - | NO | - | 父级ID |
| sort | int | - | NO | 0 | 排序 |
| create_time | datetime | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

## 4. 数据加密设计

### 4.1 加密字段说明
系统对以下敏感字段进行加密存储：
- **银行卡号**: 使用AES加密
- **身份证号**: 使用AES加密
- **手机号**: 使用AES加密
- **邮箱**: 使用AES加密
- **银行账户**: 使用AES加密

### 4.2 加密实现
```java
@EncryptedColumn  // 字段级加密注解
@EncryptedTable   // 表级加密注解
```

### 4.3 哈希字段
为了支持模糊查询，系统同时存储敏感字段的哈希值：
- **account_name_hash**: 账户名哈希值
- **phone_hash**: 手机号哈希值

## 5. 索引设计策略

### 5.1 主键索引
所有表都使用自增主键作为聚集索引

### 5.2 业务索引
- **订单表**: 按订单号、商户ID、状态、创建时间建立索引
- **用户表**: 按登录名、部门ID建立索引
- **商户表**: 按商户编码、状态建立索引

### 5.3 复合索引
根据查询场景建立复合索引：
```sql
-- 订单查询复合索引
INDEX `idx_merchant_status_time` (`platform_id`, `payment_status`, `create_time`)

-- 用户查询复合索引
INDEX `idx_dept_status` (`department_id`, `is_disabled`)
```

## 6. 数据完整性约束

### 6.1 外键约束
```sql
-- 员工部门外键
ALTER TABLE t_employee ADD CONSTRAINT fk_employee_department 
FOREIGN KEY (department_id) REFERENCES t_department(department_id);

-- 角色员工外键
ALTER TABLE t_role_employee ADD CONSTRAINT fk_role_employee_role 
FOREIGN KEY (role_id) REFERENCES t_role(role_id);
```

### 6.2 检查约束
```sql
-- 支付状态检查
ALTER TABLE t_payment_order_info ADD CONSTRAINT chk_payment_status 
CHECK (payment_status IN (1,2,3,4));

-- 订单状态检查
ALTER TABLE t_payment_order_info ADD CONSTRAINT chk_order_status 
CHECK (status IN (1,2,3));
```

## 7. 数据归档策略

### 7.1 归档规则
- **订单数据**: 超过2年的订单数据归档
- **日志数据**: 超过1年的日志数据归档
- **临时数据**: 超过30天的临时数据清理

### 7.2 归档实现
```sql
-- 创建归档表
CREATE TABLE t_payment_order_info_archive LIKE t_payment_order_info;

-- 数据归档存储过程
DELIMITER $$
CREATE PROCEDURE ArchiveOldOrders()
BEGIN
    INSERT INTO t_payment_order_info_archive 
    SELECT * FROM t_payment_order_info 
    WHERE create_time < DATE_SUB(NOW(), INTERVAL 2 YEAR);
    
    DELETE FROM t_payment_order_info 
    WHERE create_time < DATE_SUB(NOW(), INTERVAL 2 YEAR);
END$$
DELIMITER ;
```

## 8. 数据备份策略

### 8.1 备份类型
- **全量备份**: 每日凌晨进行全量备份
- **增量备份**: 每小时进行增量备份
- **实时备份**: 主从复制实时备份

### 8.2 备份脚本
```bash
#!/bin/bash
# 全量备份脚本
DATE=$(date +%Y%m%d_%H%M%S)
mysqldump -h localhost -u root -p smart_admin_v3 > /backup/smart_admin_v3_${DATE}.sql
```

## 9. 性能优化建议

### 9.1 查询优化
- 避免使用 SELECT * 查询
- 合理使用索引
- 优化复杂查询语句
- 使用分页查询

### 9.2 表结构优化
- 合理选择数据类型
- 控制表字段数量
- 避免冗余字段
- 使用适当的数据长度

### 9.3 索引优化
- 定期分析索引使用情况
- 删除未使用的索引
- 优化复合索引顺序
- 避免过多索引影响写入性能

---

**文档版本**: v1.0  
**创建日期**: 2024-09-29  
**更新日期**: 2024-09-29  
**创建人**: AI Assistant  
**审核人**: 待定
